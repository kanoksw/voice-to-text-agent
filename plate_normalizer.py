import re

# map คำอ่าน → ตัวอักษรไทย (เติมเพิ่มได้เรื่อย ๆ)
THAI_SPELL_MAP = {
    "กอไก่": "ก",
    "ขอไข่": "ข",
    "ขอควาย": "ข",
    "คอควาย": "ค",
    "งองู": "ง",
    "จอจาน": "จ",
    "ฉอฉิ่ง": "ฉ",
    "ชอช้าง": "ช",
    "ซอโซ่": "ซ",
    "ดอเด็ก": "ด",
    "ตอเต่า": "ต",
    "ถอถุง": "ถ",
    "ทอทหาร": "ท",
    "นอหนู": "น",
    "บอใบไม้": "บ",
    "ปอปลา": "ป",
    "ผอผึ้ง": "ผ",
    "ฝอฝา": "ฝ",
    "พอพาน": "พ",
    "ฟอฟัน": "ฟ",
    "มอม้า": "ม",
    "ยอยักษ์": "ย",
    "รอเรือ": "ร",
    "ลอลิง": "ล",
    "วอแหวน": "ว",
    "ศอศาลา": "ศ",
    "สอเสือ": "ส",
    "หอหีบ": "ห",
    "ฮอนกฮูก": "ฮ",
    # คำเรียกแบบย่อ/หลุด ๆ ที่ STT ชอบทำ
    "หอควาย": "ฃ",  # ถ้า STT ชอบได้ยินมั่ว ให้ map ไว้ (ปรับตามจริง)
}

# คำฟิลเลอร์ที่มักติดมา
FILLERS = ["ทะเบียน", "ป้ายทะเบียน", "รถ", "จังหวัด", "กรุงเทพ", "กทม", "จ.", "ครับ", "ค่ะ"]

def normalize_license_plate(text: str | None) -> str | None:
    if not text:
        return None

    s = text.strip()

    # ลบคำฟิลเลอร์
    for w in FILLERS:
        s = s.replace(w, " ")

    # ให้เป็น lower เพื่อความสม่ำเสมอ (ถ้ามีอังกฤษปน)
    s = s.lower()

    # แปลงคำอ่านเป็นตัวอักษรไทย
    # ทำแบบ greedy: จับ phrase ยาวก่อน
    for k in sorted(THAI_SPELL_MAP.keys(), key=len, reverse=True):
        s = s.replace(k, THAI_SPELL_MAP[k])

    # ลบทุกอย่างที่ไม่ใช่ ไทย/ตัวเลข
    s = re.sub(r"[^0-9ก-๙]", "", s)

    # รูปแบบที่เรายอมรับ: อักษรไทย 1-3 ตัว + เลข 1-4 หลัก (ปรับได้)
    m = re.fullmatch(r"([ก-๙]{1,3})(\d{1,4})", s)
    if not m:
        return None

    letters, digits = m.group(1), m.group(2)
    return f"{letters}{digits}"
